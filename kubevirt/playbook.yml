---
- hosts: all
  become: true
  environment:
    PROVIDER: k8s-1.9.3
  vars:
    exec_docker: |
      #!/bin/sh
      sudo /usr/bin/docker $*
  tasks:
    - name: install kubectl
      package:
        name: kubernetes-client
        state: present

    - name: Configuring groups for {{ ansible_user }}
      user:
        name={{ ansible_user }}
        groups=wheel
        append=yes
      become: true

    - name: configure password-less docker
      lineinfile:
        path: /etc/sudoers
        state: present
        line: '%wheel ALL=(ALL) NOPASSWD: /usr/bin/docker'

    - name: always execute docker via sudo
      copy:
        content: '{{ exec_docker }}'
        dest: /usr/local/bin/docker
        mode: 0755

    - name: configure kvm_intel for nested virtualization
      copy:
        content: 'options kvm-intel nested=1'
        dest: /etc/modprobe.d/kvm_intel.conf

    - name: check if nested virtualization is enabled
      shell: cat /sys/module/kvm_intel/parameters/nested | grep Y
      register: nested_check
      ignore_errors: true
      become: false

    - name: unload kvm_intel to enable nested virtualization
      modprobe:
        name: kvm_intel
        state: absent
      when: nested_check is failed

    - name: load kvm_intel to enable nested virtualization
      modprobe:
        name: kvm_intel
        state: present

    - name: install git
      package:
        name: git
        state: present

    - name: Clone kubevirt
      git:
        repo: https://github.com/kubevirt/kubevirt.git
        dest: kubevirt
      become: false

    - name: Install docker
      package:
        name: docker
        state: present

    - name: Start docker
      systemd:
        name: docker
        enabled: yes
        state: started

    - stat: path=.kubevirt_deployed
      register: kubevirt_deployed

    - name: Bring KubeVirt cluster up
      command: chdir=kubevirt make cluster-up
      become: false
      when: kubevirt_deployed.stat.exists == False

    - name: Sync KubeVirt cluster
      command: chdir=kubevirt make cluster-sync
      become: false
      when: kubevirt_deployed.stat.exists == False

    - file:
        path: .kubevirt_deployed
        state: touch
